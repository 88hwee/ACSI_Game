<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Local Hero: Alien Defense - HISTORY EDITION</title>
  <style>
    body { margin: 0; background: #000; color: #fff; font-family: "Courier New", Courier, monospace; overflow: hidden; }
    #game-stage { position: relative; width: 100vw; height: 100vh; background: linear-gradient(to bottom, #000033 0%, #000 100%); }

    #hud {
      position: absolute; top: 0; left: 0; width: 100%;
      display: flex; justify-content: space-around; padding: 15px;
      background: rgba(0,0,0,0.8); border-bottom: 2px solid #00ff00; z-index: 10;
      box-sizing: border-box;
    }
    .stat { font-size: 18px; color: #00ff00; }

    #hero {
      position: absolute; bottom: 20px;
      width: 60px; height: 60px; font-size: 50px; text-align: center;
      transform: translateX(-50%);
      z-index: 5; user-select: none;
      transition: left 0.1s ease-out;
    }
    #hero::after { content: "üõ°Ô∏è"; }

    .alien {
      position: absolute; width: 60px; height: 60px;
      font-size: 40px; text-align: center;
      z-index: 4; user-select: none;
      transform: translateX(-50%);
    }
    .alien::after { content: "üõ∏"; }

    .bomb {
      position: absolute; width: 60px; height: 60px;
      font-size: 40px; text-align: center;
      z-index: 4; user-select: none;
      transform: translateX(-50%);
    }
    .bomb::after { content: "üí£"; }

    .laser {
      position: absolute; width: 4px; height: 20px;
      background: #00ff00; box-shadow: 0 0 10px #00ff00; z-index: 3;
      transform: translateX(-50%);
    }

    #mcq-modal {
      display: none;
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.95);
      border: 3px solid #00ff00;
      padding: 20px; width: 90%; max-width: 600px;
      z-index: 100; border-radius: 15px; text-align: center;
      box-sizing: border-box;
    }

    #crisis-timer-display {
      font-size: 30px; color: #ff0000; font-weight: bold; margin-bottom: 10px; display: none;
    }

    .option-btn {
      display: block; width: 100%;
      margin: 8px 0; padding: 12px;
      background: #111; color: #00ff00;
      border: 1px solid #00ff00; cursor: pointer;
      font-size: 16px; border-radius: 5px; transition: 0.2s;
    }
    .option-btn:hover { background: #222; }
    .option-btn:disabled { cursor: default; opacity: 0.9; }

    .wrong-highlight { background: #aa0000 !important; color: #fff !important; border-color: red !important; }
    .correct-highlight { background: #00aa00 !important; color: #fff !important; border-color: #00ff00 !important; }

    #end-screen {
      display: none;
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: #000;
      flex-direction: column; align-items: center; justify-content: center;
      z-index: 600; gap: 10px; text-align: center;
      padding: 20px; box-sizing: border-box;
    }
    #end-screen button { padding: 15px 30px; background: #00ff00; border: none; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>
  <div id="game-stage" tabindex="0">
    <div id="hud">
      <div class="stat">TIME: <span id="timer">90</span>s</div>
      <div class="stat">SCORE: <span id="score">0</span></div>
      <div class="stat">LIVES: <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    </div>

    <div id="hero"></div>

    <div id="mcq-modal">
      <div id="crisis-timer-display">BOMB CRISIS! <span id="crisis-sec">10</span>s</div>
      <h3 id="question-text"></h3>
      <div id="options-container"></div>
      <div id="feedback" style="margin-top:12px; color:#00ff00; display:none; min-height: 20px;"></div>
    </div>

    <div id="end-screen">
      <h1 id="end-title">GAME OVER</h1>
      <h2 id="final-score"></h2>
      <button id="restart-btn">RESTART</button>
    </div>
  </div>

  <script>
    const GAME_SECONDS = 90;
    const START_LIVES = 5;
    const SPAWN_EVERY_MS = 1200;
    const FIRE_COOLDOWN_MS = 250;

    const questions = [
      { q: "Which three countries formed the Triple Alliance?", a: "Germany, Austria-Hungary, Italy", o: ["Britain, France, Russia", "Germany, Austria-Hungary, Italy", "Germany, Russia, Italy", "Britain, Italy, Japan"] },
      { q: "The Triple Entente was a reaction to which alliance?", a: "The Triple Alliance", o: ["The League of Nations", "The Triple Alliance", "The Central Powers", "The Axis Powers"] },
      { q: "What term described Kaiser Wilhelm II‚Äôs fear of being surrounded?", a: "Encirclement", o: ["Isolationism", "Annexation", "Encirclement", "Entrenchment"] },
      { q: "Which country had the largest military personnel (6.0m) by 1914?", a: "Russia", o: ["Germany", "France", "Russia", "Britain"] },
      { q: "Which territory's annexation in 1908 caused major tension?", a: "Bosnia", o: ["Serbia", "Bosnia", "Sarajevo", "Bulgaria"] },
      { q: "Who was assassinated in Sarajevo, sparking WWI?", a: "Archduke Franz Ferdinand", o: ["Kaiser Wilhelm II", "Archduke Franz Ferdinand", "Tsar Nicholas II", "Woodrow Wilson"] },
      { q: "What was Germany‚Äôs primary naval goal under Wilhelm II?", a: "To rival Britain's navy", o: ["To protect merchant ships", "To rival Britain's navy", "To explore the Atlantic", "To transport troops"] },
      { q: "Which country switched from the Triple Alliance to the Entente?", a: "Italy", o: ["Japan", "Italy", "Russia", "Ottoman Empire"] },
      { q: "What was the estimated total death toll of WWI?", a: "40 million", o: ["9 million", "20 million", "40 million", "60 million"] },
      { q: "Which treaty allowed Russia to exit the war early?", a: "Treaty of Brest-Litovsk", o: ["Versailles", "St. Germain", "Brest-Litovsk", "Trianon"] },
      { q: "In the Russian Civil War, the 'Reds' represented whom?", a: "The Bolshevik Party", o: ["Tsar supporters", "The Bolshevik Party", "Foreign troops", "Landowners"] },
      { q: "Who were the 'Whites' in the Russian Civil War?", a: "Anti-Bolshevik movements", o: ["The Red Army", "Anti-Bolshevik movements", "French allies", "German forces"] },
      { q: "Which country emerged from WWI as the world's greatest power?", a: "United States", o: ["Britain", "France", "United States", "Japan"] },
      { q: "What was Woodrow Wilson‚Äôs proposal for peace called?", a: "The Fourteen Points", o: ["The Atlantic Charter", "The Fourteen Points", "The League Covenant", "The Young Plan"] },
      { q: "Who were the 'Big Three' at the Paris Peace Conference?", a: "USA, Britain, France", o: ["Britain, France, Italy", "USA, Britain, France", "USA, Britain, Germany", "France, Italy, Russia"] },
      { q: "Who was the Prime Minister of France during the conference?", a: "Georges Clemenceau", o: ["David Lloyd George", "Georges Clemenceau", "Woodrow Wilson", "Vladimir Lenin"] },
      { q: "What is an armistice?", a: "Agreement to stop fighting", o: ["Peace treaty", "Agreement to stop fighting", "Declaration of war", "Alliance"] },
      { q: "What does the term 'Tsar' refer to?", a: "Emperor of Russia", o: ["Elected leader", "Emperor of Russia", "Military commander", "Communist official"] },
      { q: "How much in reparations did Russia pay Germany in 1918?", a: "6 billion marks", o: ["1 billion marks", "6 billion marks", "10 billion marks", "40 million"] },
      { q: "Who believed the state should run all land and industry?", a: "The Bolsheviks", o: ["The Whites", "The Bolsheviks", "The Triple Entente", "The Great Powers"] },
      { q: "What happened to the Kaiser at the end of the war?", a: "Overthrown in revolution", o: ["Promoted", "Overthrown in revolution", "Became US ally", "Led the League"] },
      { q: "How many republics made up the USSR by 1922?", a: "15", o: ["5", "10", "15", "20"] },
      { q: "What was the primary aim of the Paris Peace Conference?", a: "Officially end WWI", o: ["Start a new war", "Officially end WWI", "Rebuild German navy", "Annex Russia"] },
      { q: "Which was NOT part of the Triple Entente?", a: "Italy", o: ["Britain", "France", "Italy", "Russia"] },
      { q: "Who was overthrown in the March 1917 revolution?", a: "Tsar Nicholas II", o: ["Lenin", "Tsar Nicholas II", "Wilhelm II", "Wilson"] },
      { q: "Wilson wanted the world to be safe for what?", a: "Every peace-loving nation", o: ["Empires", "Every peace-loving nation", "Dictators", "Alliances"] },
      { q: "Which alliance was NOT a legally binding commitment?", a: "Triple Entente", o: ["Triple Alliance", "Triple Entente", "League of Nations", "USSR"] }
    ];

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function escapeHTML(s) {
      return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    const qPool = shuffle([...questions]);
    const stage = document.getElementById("game-stage");
    const hero = document.getElementById("hero");
    const restartBtn = document.getElementById("restart-btn");
    const feedbackEl = document.getElementById("feedback");
    const modal = document.getElementById("mcq-modal");
    const container = document.getElementById("options-container");
    const crisisDisplay = document.getElementById("crisis-timer-display");
    const crisisSec = document.getElementById("crisis-sec");

    let currentHeroPos = 50;
    let score = 0;
    let lives = START_LIVES;
    let timeLeft = GAME_SECONDS;
    let gameRunning = true;
    let pausedForMCQ = false;
    let qIndex = 0;
    let isCrisis = false;
    let crisisQuestionsNeeded = 0;
    let crisisTimeLeft = 10;
    let crisisTimerInterval = null;

    const aliens = new Set();
    const bombs = new Set();
    let spawnInterval = null;
    let lastFireAt = 0;

    // Movement & Shooting
    window.addEventListener("keydown", (e) => {
      if (!gameRunning || pausedForMCQ) return;
      if (e.key === "ArrowLeft") moveHero(-6);
      if (e.key === "ArrowRight") moveHero(6);
      if (e.key === " ") fireLaser();
    });

    function moveHero(delta) {
      currentHeroPos = Math.max(5, Math.min(95, currentHeroPos + delta));
      hero.style.left = currentHeroPos + "%";
    }

    function fireLaser() {
      const now = Date.now();
      if (now - lastFireAt < FIRE_COOLDOWN_MS) return;
      lastFireAt = now;

      const laser = document.createElement("div");
      laser.className = "laser";
      laser.style.left = currentHeroPos + "%";
      laser.style.bottom = "80px";
      stage.appendChild(laser);

      const move = setInterval(() => {
        if (!gameRunning || pausedForMCQ) { clearInterval(move); laser.remove(); return; }
        const btm = parseInt(laser.style.bottom, 10);
        laser.style.bottom = (btm + 12) + "px";

        // Collision with Aliens
        for (const alien of aliens) {
          if (isColliding(laser, alien)) {
            clearInterval(move);
            laser.remove();
            onAlienHit(alien);
            return;
          }
        }

        if (btm > window.innerHeight) { clearInterval(move); laser.remove(); }
      }, 20);
    }

    function onAlienHit(alien) {
      alien.remove();
      aliens.delete(alien);
      score += 50;
      updateStats();
      startQuiz(false);
    }

    function startQuiz(crisis) {
      pausedForMCQ = true;
      modal.style.display = "block";
      isCrisis = crisis;
      
      if (crisis) {
        crisisQuestionsNeeded = 2;
        crisisTimeLeft = 10;
        crisisDisplay.style.display = "block";
        crisisSec.innerText = crisisTimeLeft;
        
        crisisTimerInterval = setInterval(() => {
          crisisTimeLeft--;
          crisisSec.innerText = crisisTimeLeft;
          if (crisisTimeLeft <= 0) {
            clearInterval(crisisTimerInterval);
            endGame("BOMB EXPLODED!");
          }
        }, 1000);
      } else {
        crisisDisplay.style.display = "none";
      }
      
      showNextQuestion();
    }

    function showNextQuestion() {
      feedbackEl.style.display = "none";
      const qData = qPool[qIndex % qPool.length];
      document.getElementById("question-text").innerText = qData.q;
      container.innerHTML = "";

      const options = shuffle([...qData.o]);
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.innerText = opt;
        btn.onclick = () => {
          const allBtns = container.querySelectorAll("button");
          allBtns.forEach(b => b.disabled = true);

          if (opt === qData.a) {
            btn.classList.add("correct-highlight");
            score += 100;
            qIndex++;
            handleCorrect();
          } else {
            btn.classList.add("wrong-highlight");
            const correctBtn = Array.from(allBtns).find(b => b.innerText === qData.a);
            if (correctBtn) correctBtn.classList.add("correct-highlight");
            feedbackEl.style.display = "block";
            feedbackEl.innerHTML = `Correct: <strong>${escapeHTML(qData.a)}</strong>`;
            lives = Math.max(0, lives - 1);
            updateStats();
            
            setTimeout(() => {
              qIndex++;
              if (isCrisis) {
                // In crisis, if you get it wrong, it doesn't count towards the 2 needed
                showNextQuestion();
              } else {
                resumeGame();
              }
            }, 2500);
          }
        };
        container.appendChild(btn);
      });
    }

    function handleCorrect() {
      setTimeout(() => {
        if (isCrisis) {
          crisisQuestionsNeeded--;
          if (crisisQuestionsNeeded <= 0) {
            clearInterval(crisisTimerInterval);
            resumeGame();
          } else {
            showNextQuestion();
          }
        } else {
          resumeGame();
        }
      }, 800);
    }

    function resumeGame() {
      modal.style.display = "none";
      pausedForMCQ = false;
      isCrisis = false;
      updateStats();
      if (lives <= 0) endGame("NO LIVES LEFT");
    }

    // Spawning logic
    function spawnLoop() {
      if (!gameRunning || pausedForMCQ) return;
      
      // Randomly spawn bomb or alien
      if (Math.random() < 0.15) {
        spawnBomb();
      } else {
        spawnAlien();
      }
    }

    function spawnAlien() {
      const alien = document.createElement("div");
      alien.className = "alien";
      alien.style.left = (Math.random() * 90 + 5) + "%";
      alien.style.top = "80px";
      stage.appendChild(alien);
      aliens.add(alien);

      const fall = setInterval(() => {
        if (!gameRunning) { clearInterval(fall); return; }
        if (pausedForMCQ) return;
        const top = alien.offsetTop;
        alien.style.top = (top + 3) + "px";

        if (top > window.innerHeight - 100) {
          clearInterval(fall);
          if (alien.isConnected) alien.remove();
          aliens.delete(alien);
          lives = Math.max(0, lives - 1);
          updateStats();
        }
      }, 30);
    }

    function spawnBomb() {
      const bomb = document.createElement("div");
      bomb.className = "bomb";
      bomb.style.left = (Math.random() * 90 + 5) + "%";
      bomb.style.top = "80px";
      stage.appendChild(bomb);
      bombs.add(bomb);

      const fall = setInterval(() => {
        if (!gameRunning) { clearInterval(fall); return; }
        if (pausedForMCQ) return;
        const top = bomb.offsetTop;
        bomb.style.top = (top + 5) + "px";

        // Collision with Hero
        if (isColliding(hero, bomb)) {
          clearInterval(fall);
          bomb.remove();
          bombs.delete(bomb);
          startQuiz(true); // Crisis mode
          return;
        }

        if (top > window.innerHeight) {
          clearInterval(fall);
          bomb.remove();
          bombs.delete(bomb);
        }
      }, 30);
    }

    function isColliding(a, b) {
      const r1 = a.getBoundingClientRect();
      const r2 = b.getBoundingClientRect();
      return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
    }

    function updateStats() {
      document.getElementById("score").innerText = score;
      document.getElementById("timer").innerText = timeLeft;
      document.getElementById("lives").innerText = "‚ù§Ô∏è".repeat(lives);
    }

    function endGame(title) {
      gameRunning = false;
      pausedForMCQ = true;
      clearInterval(spawnInterval);
      clearInterval(gameTimerInterval);
      if (crisisTimerInterval) clearInterval(crisisTimerInterval);
      document.getElementById("end-screen").style.display = "flex";
      document.getElementById("end-title").innerText = title;
      document.getElementById("final-score").innerText = "FINAL SCORE: " + score;
    }

    const gameTimerInterval = setInterval(() => {
      if (!gameRunning || pausedForMCQ) return;
      timeLeft--;
      updateStats();
      if (timeLeft <= 0) endGame("TIME'S UP!");
    }, 1000);

    spawnInterval = setInterval(spawnLoop, SPAWN_EVERY_MS);
    restartBtn.onclick = () => location.reload();
    hero.style.left = "50%";
    updateStats();
  </script>
</body>
</html>
