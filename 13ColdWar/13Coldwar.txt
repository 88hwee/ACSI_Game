<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cold War Origins: Mastery Quest</title>
    <style>
        body { margin: 0; background: #111; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; }
        #game-container {
            position: relative; width: 800px; height: 400px; margin: 20px auto;
            background: linear-gradient(to bottom, #87CEEB, #b0e2ff);
            border: 4px solid #333; overflow: hidden;
        }
        canvas { display: block; }
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 200;
        }
        #btn-start {
            padding: 15px 35px; font-size: 22px; font-weight: bold; color: #111;
            background: #ffd700; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        #btn-start:hover { transform: scale(1.1); background: #fff; }
        #ui-layer { position: absolute; top: 15px; left: 20px; right: 20px; pointer-events: none; display: flex; justify-content: space-between; font-weight: bold; text-shadow: 2px 2px #000; font-size: 18px; z-index: 10; }
        #stats-coins { color: #ffd700; }
        #quiz-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column;
            justify-content: center; align-items: center; text-align: center; padding: 20px; z-index: 100;
        }
        .option-btn { background: #fff; color: #111; border: none; padding: 12px; margin: 5px; cursor: pointer; width: 85%; border-radius: 8px; font-size: 16px; font-weight: bold; }
        .option-btn:hover { background: #FFD700; }
        #message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; display: none; text-align: center; text-shadow: 4px 4px 0px #000; z-index: 110; font-weight: 900; color: #ff4d4d; width: 100%; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="start-screen">
        <h1 style="color: gold;">Cold War Mastery Quest</h1>
        <p>Correct = Question Removed | Wrong = Falling & Retry Later</p>
        <button id="btn-start">START GAME</button>
    </div>
    <div id="ui-layer">
        <div id="stats-lives" style="color:#ff4d4d">Lives: 3</div>
        <div id="stats-coins">Coins: 0</div>
        <div id="stats-timer">120s</div>
    </div>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <div id="quiz-overlay">
        <div id="question-text" style="color: gold; font-size: 19px; margin-bottom: 15px;"></div>
        <div id="options-container" style="width:100%"></div>
    </div>
    <div id="message"></div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const failSound = new Audio('mixkit-player-losing-or-failing-2042.wav');

let gameStarted = false, gameActive = false, isFalling = false;
let timer = 120, lives = 3, coins = 0, streak = 0;
const gravity = 0.45;

const player = { x: 100, y: 200, w: 40, h: 65, vx: 0, vy: 0, speed: 5, jumpPower: -11, grounded: false, facingRight: true };

/* ===== UPDATED MCQ DECK (Cold War / WWII Endgame) ===== */
let questionsDeck = [
  // I. Atomic Bomb
  { q: "What were the code names for the two atomic bombs used against Japan?", a: ["Trinity and S-1", "Little Boy and Fat Man", "Olympic and Coronet", "Silverplate and Centerboard"], correct: "Little Boy and Fat Man" },
  { q: "Which city was the primary target of the first atomic mission on 6 August 1945?", a: ["Nagasaki", "Kokura", "Hiroshima", "Kyoto"], correct: "Hiroshima" },
  { q: "What was the name of the first nuclear test explosion in New Mexico (July 1945)?", a: ["Operation Centerboard", "Trinity", "Manhattan Project", "Operation Meetinghouse"], correct: "Trinity" },
  { q: "Why did Henry Stimson insist on removing Kyoto from the target list?", a: ["It had no military significance.", "Due to its historical, religious, and cultural significance.", "It had already been destroyed by firebombing.", "He wanted it to be post-war occupation HQ."], correct: "Due to its historical, religious, and cultural significance." },
  { q: "According to Stimson, the main psychological purpose of using the bomb was to:", a: ["Test the weapon for scientific data.", "Shock the Japanese ruling oligarchy into surrender.", "Intimidate the Soviet Union at the start of the Cold War.", "Destroy Japanese race and culture."], correct: "Shock the Japanese ruling oligarchy into surrender." },

  // II. Delay (Second Front)
  { q: "In which year did Stalin first request the Allies open a Second Front in Western Europe?", a: ["1941", "1942", "1943", "1944"], correct: "1941" },
  { q: "Why was Stalin angry about the delay in opening the Second Front?", a: ["He wanted to invade Britain.", "It let Hitler concentrate forces against the USSR.", "He wanted American nuclear technology.", "He wanted to avoid the Nazi–Soviet Pact."], correct: "It let Hitler concentrate forces against the USSR." },
  { q: "What did Stalin suspect was the motive behind the delay in invading Western Europe?", a: ["The Allies lacked a navy.", "They wanted Germany and USSR to weaken each other.", "They were secretly helping Hitler.", "They prioritised the war in China."], correct: "They wanted Germany and USSR to weaken each other." },
  { q: "Which operation finally opened the Second Front in June 1944?", a: ["African Campaign", "Invasion of Italy", "D-Day landings in Normandy", "Operation Barbarossa"], correct: "D-Day landings in Normandy" },
  { q: "Which leader was most vocal that a landing in Western Europe would cause prohibitive casualties?", a: ["Joseph Stalin", "Winston Churchill", "Harry Truman", "Charles de Gaulle"], correct: "Winston Churchill" },

  // III. Potsdam Conference
  { q: "Who replaced Franklin D. Roosevelt at the Potsdam Conference?", a: ["George Marshall", "Harry S. Truman", "Clement Attlee", "Averell Harriman"], correct: "Harry S. Truman" },
  { q: "What extraordinary information did Truman privately reveal to Stalin at Potsdam?", a: ["US leaving the war", "US tested a new weapon of mass destruction", "Germany had surrendered", "No free elections in Poland"], correct: "US tested a new weapon of mass destruction" },
  { q: "At Potsdam, what did the Big Three decide about Germany?", a: ["Make it agricultural", "Divide into four occupation zones", "Keep it unified and unarmed", "Annex it into the USSR"], correct: "Divide into four occupation zones" },
  { q: "The Potsdam Declaration (26 July 1945) mainly:", a: ["Defined Poland’s borders", "Outlined terms for Japan’s surrender", "Created the UN", "Split the Balkans into spheres"], correct: "Outlined terms for Japan’s surrender" },
  { q: "Which leader attended Tehran, Yalta, AND Potsdam?", a: ["Winston Churchill", "Franklin Roosevelt", "Joseph Stalin", "Harry Truman"], correct: "Joseph Stalin" },

  // IV. Yalta Conference
  { q: "Where and when was the Yalta Conference held?", a: ["Germany, July 1945", "Crimea, February 1945", "Iran, November 1943", "Missouri, March 1946"], correct: "Crimea, February 1945" },
  { q: "What was the major concrete Pacific War accomplishment at Yalta?", a: ["Immediate Japanese surrender", "Stalin pledged to enter war vs Japan 3 months after Germany’s defeat", "Bombing of Hiroshima", "Division of Korea at 38th parallel"], correct: "Stalin pledged to enter war vs Japan 3 months after Germany’s defeat" },
  { q: "What did the Allies agree about UN voting procedures?", a: ["All nations equal power", "Permanent Security Council members have veto", "Only US and USSR vote", "UN located in Moscow"], correct: "Permanent Security Council members have veto" },
  { q: "The Declaration of Liberated Europe promised:", a: ["Permanent Soviet occupation of Germany", "Free elections for democratic institutions in liberated states", "Return of all monarchs", "Marshall Plan economic aid"], correct: "Free elections for democratic institutions in liberated states" },
  { q: "Which nation received a fourth occupation zone in Germany carved from US/UK zones?", a: ["Poland", "France", "Italy", "Canada"], correct: "France" },

  // V. Kennan (Long Telegram)
  { q: "About how many words was George Kennan’s Long Telegram (1946)?", a: ["800", "1,500", "8,000", "20,000"], correct: "8,000" },
  { q: "What core foreign policy concept did Kennan propose?", a: ["Appeasement", "Containment", "Isolationism", "Rollback"], correct: "Containment" },
  { q: "Kennan said Soviet power was impervious to the logic of reason but sensitive to:", a: ["Economic aid", "The logic of force", "Democratic elections", "International law"], correct: "The logic of force" },
  { q: "Kennan argued the Kremlin’s neurotic worldview came from:", a: ["Desire for global trade", "An instinctive Russian sense of insecurity", "Belief in UN Charter", "Desire to cooperate with the West"], correct: "An instinctive Russian sense of insecurity" },
  { q: "Kennan compared world communism to:", a: ["Beneficial bacteria", "A malignant parasite feeding on diseased tissue", "A slow-moving tortoise", "A protective shield"], correct: "A malignant parasite feeding on diseased tissue" },

  // VI. Truman Doctrine
  { q: "When was the Truman Doctrine announced?", a: ["February 1945", "March 1947", "June 1948", "April 1949"], correct: "March 1947" },
  { q: "The Truman Doctrine marked a sharp break from traditional US:", a: ["Isolationism", "Interventionism", "Imperialism", "Globalism"], correct: "Isolationism" },
  { q: "Truman said the US should support:", a: ["Only capitalist nations", "Free peoples resisting subjugation by armed minorities or outside pressures", "USSR’s right to a buffer zone", "All UN nations"], correct: "Free peoples resisting subjugation by armed minorities or outside pressures" },
  { q: "How much initial aid did Truman request for Greece and Turkey?", a: ["$100 million", "$400 million", "$1 billion", "$13 billion"], correct: "$400 million" },
  { q: "The Truman Doctrine responded to a power vacuum left by the decline of:", a: ["Germany", "Great Britain", "France", "Japan"], correct: "Great Britain" },

  // VII. Greece Crisis
  { q: "Why did Britain tell the US in 1947 it could no longer support Greece?", a: ["Greece became communist", "Britain lacked financial/military resources", "Britain wanted to join USSR", "Britain focused on war with Japan"], correct: "Britain lacked financial/military resources" },
  { q: "Which group tried to take over the Greek government in 1946?", a: ["Nazi Party", "Greek Communist Party (EAM/ELAS)", "Ottoman Empire", "Red Guards"], correct: "Greek Communist Party (EAM/ELAS)" },
  { q: "Truman feared if Greece fell, which neighbour would be endangered next?", a: ["Italy", "Turkey", "Poland", "Iran"], correct: "Turkey" },
  { q: "By 1949, the communists in Greece were:", a: ["Victorious", "Defeated", "In coalition with monarchists", "Annexed by USSR"], correct: "Defeated" },
  { q: "Dean Acheson used which theory to explain the danger?", a: ["Salami Tactics", "Domino Theory", "Iron Curtain Theory", "New Look Policy"], correct: "Domino Theory" },

  // VIII. Marshall Plan
  { q: "The Marshall Plan was named after:", a: ["Harry Truman", "George C. Marshall", "William Tunner", "Winston Churchill"], correct: "George C. Marshall" },
  { q: "The main objective of the Marshall Plan was to:", a: ["Launch war on USSR", "Provide economic aid to rebuild Europe and resist communism", "Build the Berlin Wall", "Arrest all communist leaders"], correct: "Provide economic aid to rebuild Europe and resist communism" },
  { q: "marshall Plan: Approximately how much aid was given (1948–1952)?", a: ["$400 million", "$2 billion", "$13 billion", "$50 billion"], correct: "$13 billion" },
  { q: "Stalin attacked the Marshall Plan as:", a: ["Capitalist Charity", "Dollar Imperialism", "Democratic Expansion", "The Great Gamble"], correct: "Dollar Imperialism" },
  { q: "Largest beneficiaries of Marshall aid were:", a: ["Greece and Turkey", "Britain and France", "Germany and Italy", "Poland and Czechoslovakia"], correct: "Britain and France" },

  // IX. Stalin Taking Over Eastern Europe
  { q: "Stalin called pro-Soviet regimes protecting the USSR:", a: ["Democratic Allies", "Satellite States / Buffer Zone", "Red Core", "Socialist Center"], correct: "Satellite States / Buffer Zone" },
  { q: "Why was Stalin determined to control Eastern Europe after WWII?", a: ["Market for Soviet goods", "Prevent future invasions from the West", "Follow Marshall Plan terms", "Join NATO"], correct: "Prevent future invasions from the West" },
  { q: "By July 1945, Soviet troops effectively controlled:", a: ["Britain and France", "Baltic states, Poland, Czechoslovakia, Hungary, Bulgaria, Romania", "Greece and Turkey", "Italy and Spain"], correct: "Baltic states, Poland, Czechoslovakia, Hungary, Bulgaria, Romania" },
  { q: "“Baggage Train” leaders were:", a: ["Supply soldiers", "Moscow-trained communists returning home to lead pro-Soviet governments", "Refugees fleeing West", "Pro-Marshall Plan politicians"], correct: "Moscow-trained communists returning home to lead pro-Soviet governments" },
  { q: "Which government-in-exile was largely excluded after the war (London Poles)?", a: ["Hungary", "Poland", "Czechoslovakia", "Romania"], correct: "Poland" },

  // X. Salami Tactics
  { q: "Who coined the term “Salami Tactics”?", a: ["Joseph Stalin", "Matyas Rakosi", "Winston Churchill", "George Kennan"], correct: "Matyas Rakosi" },
  { q: "“Salami Tactics” means:", a: ["Food prep for Red Army", "Step-by-step elimination of opposition to gain total control", "Rapid invasion", "Division of Germany"], correct: "Step-by-step elimination of opposition to gain total control" },
  { q: "Typical first stage of Salami Tactics:", a: ["Execute opponents immediately", "Create a broad “anti-fascist” coalition government", "Ban all parties", "Join NATO"], correct: "Create a broad “anti-fascist” coalition government" },
  { q: "In Hungary, Rakosi used which secret police to arrest opponents?", a: ["KGB", "AVO/AVH", "Gestapo", "Stasi"], correct: "AVO/AVH" },
  { q: "By which year did only Greece remain non-communist in Eastern Europe?", a: ["1945", "1946", "1947", "1948"], correct: "1948" },

  // XI. NATO
  { q: "NATO stands for:", a: ["North American Trade Office", "North Atlantic Treaty Organization", "National Anti-Totalitarian Organization", "Northern Alliance for Territorial Order"], correct: "North Atlantic Treaty Organization" },
  { q: "NATO was established in:", a: ["1945", "1947", "1948", "1949"], correct: "1949" },
  { q: "Article 5 in NATO means:", a: ["Economic aid", "Attack on one is attack on all", "USSR can join", "Bans nuclear weapons"], correct: "Attack on one is attack on all" },
  { q: "NATO was the first time the US joined a:", a: ["Trade bloc", "Peacetime military alliance", "Temporary wartime partnership", "Secret spy network"], correct: "Peacetime military alliance" },
  { q: "Which country joined NATO in 1955, prompting the Warsaw Pact?", a: ["West Germany", "Greece", "Turkey", "France"], correct: "West Germany" },

  // XII. Warsaw Pact
  { q: "The Warsaw Pact was formed in:", a: ["1949", "1951", "1953", "1955"], correct: "1955" },
  { q: "Which communist state in Eastern Europe did NOT join the Warsaw Pact?", a: ["Poland", "Yugoslavia", "Hungary", "Albania"], correct: "Yugoslavia" },
  { q: "Primary reason for the Warsaw Pact:", a: ["Coordinate Marshall Plan", "Response to West Germany joining NATO", "Invade the US", "Build Berlin Wall"], correct: "Response to West Germany joining NATO" },
  { q: "Senior positions and central military command were held by:", a: ["All members equally", "Soviet officials and commanders", "UN Security Council", "East German military"], correct: "Soviet officials and commanders" },
  { q: "Used by USSR in 1956 and 1968 to:", a: ["Provide humanitarian aid", "Crush uprisings and keep members in line", "Negotiate peace with NATO", "Dismantle Iron Curtain"], correct: "Crush uprisings and keep members in line" },

  // XIII. Comecon
  { q: "Purpose of Comecon:", a: ["Coordinate military attacks", "Coordinate economic policy and trade of communist states", "Spread anti-US propaganda", "Manage Berlin Airlift"], correct: "Coordinate economic policy and trade of communist states" },
  { q: "Comecon was established in:", a: ["1947", "1949", "1953", "1955"], correct: "1949" },
  { q: "Comecon was the Soviet response to:", a: ["NATO", "Marshall Plan", "Truman Doctrine", "Berlin Airlift"], correct: "Marshall Plan" },
  { q: "Comecon shifted trade for members like Bulgaria to:", a: ["US trade", "Mostly within the communist bloc (around 90% by 1950s)", "No trade at all", "Free-market economy"], correct: "Mostly within the communist bloc (around 90% by 1950s)" },
  { q: "Comecon administered financial aid via:", a: ["Truman Plan", "Molotov Plan", "Five-Year Plan", "Marshall Aid Plan"], correct: "Molotov Plan" },

  // XIV. Cominform
  { q: "Cominform stands for:", a: ["Communist Information Forum", "Communist Information Bureau", "Committee for International Reform", "Command for Information and Military"], correct: "Communist Information Bureau" },
  { q: "Cominform was established in:", a: ["February 1945", "September 1947", "January 1949", "May 1955"], correct: "September 1947" },
  { q: "Main goal of Cominform:", a: ["Aid Western Europe", "Coordinate European communist parties under Soviet control", "Peace treaty with US", "Build wall in Berlin"], correct: "Coordinate European communist parties under Soviet control" },
  { q: "Which country was expelled from Cominform in 1948?", a: ["Poland", "Yugoslavia", "Hungary", "Czechoslovakia"], correct: "Yugoslavia" },
  { q: "Stalin used Cominform meetings mainly to:", a: ["Promote religious freedom", "Spread anti-US propaganda and enforce Moscow’s line", "Share nuclear secrets", "Discuss joining the UN"], correct: "Spread anti-US propaganda and enforce Moscow’s line" },

  // XV. Berlin Blockade
  { q: "The Berlin Blockade began in:", a: ["March 1947", "June 1948", "May 1949", "August 1961"], correct: "June 1948" },
  { q: "Immediate trigger for the blockade:", a: ["Formation of NATO", "New Deutsche Mark in Western sectors", "Start of Korean War", "Iron Curtain speech"], correct: "New Deutsche Mark in Western sectors" },
  { q: "How did Stalin carry out the blockade?", a: ["Built a wall", "Cut rail/road/water links to West Berlin", "Bombed the city", "Invaded West Germany"], correct: "Cut rail/road/water links to West Berlin" },
  { q: "Stalin’s main goal was to:", a: ["Feed the population", "Force Western Powers out of Berlin", "Start WWIII", "Join Marshall Plan"], correct: "Force Western Powers out of Berlin" },
  { q: "West Berlin was located:", a: ["On border of French/Soviet zones", "About 100 miles inside Soviet-controlled zone", "In centre of American zone", "On Baltic coast"], correct: "About 100 miles inside Soviet-controlled zone" },

  // XVI. Berlin Airlift
  { q: "US code name for the Berlin Airlift:", a: ["Operation Downfall", "Operation Vittles", "Operation Centerboard", "Operation Little Boy"], correct: "Operation Vittles" },
  { q: "Who managed airlift logistics and scheduling?", a: ["George Marshall", "William Tunner", "Paul Tibbets", "Curtis LeMay"], correct: "William Tunner" },
  { q: "Pilot Gail Halvorsen was nicknamed:", a: ["The Sky King", "The Candy Bomber", "The Berlin Ace", "The Propeller Prince"], correct: "The Candy Bomber" },
  { q: "How long did the airlift last before the blockade was lifted?", a: ["3 months", "6 months", "11 months (continued longer as buffer)", "2 years"], correct: "11 months (continued longer as buffer)" },
  { q: "Record set on New Year’s Eve 1948:", a: ["1,000 tons", "4,000 tons", "Over 6,000 tons", "10,000 tons"], correct: "Over 6,000 tons" },

  // XVII. Trizonia
  { q: "Bizonia (early 1948) was:", a: ["A new Soviet tank", "UK + US zones merged into one economic unit", "A code name for airlift", "A hydrogen bomb target"], correct: "UK + US zones merged into one economic unit" },
  { q: "In April 1949, which country joined Bizonia to create Trizonia?", a: ["Italy", "France", "West Germany", "Belgium"], correct: "France" },
  { q: "Trizonia + a new currency led directly to:", a: ["Berlin Blockade", "End of Cold War", "Creation of UN", "Japan’s surrender"], correct: "Berlin Blockade" },
  { q: "Trizonia later became:", a: ["GDR", "FRG (West Germany)", "EU", "Warsaw Pact"], correct: "FRG (West Germany)" },
  { q: "Why combine zones into Trizonia?", a: ["Give land to USSR", "Rebuild German economy; separate zones drained resources", "Create secret nuclear site", "Fulfil Morgenthau Plan"], correct: "Rebuild German economy; separate zones drained resources" }
];

function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }
shuffle(questionsDeck);

const blocks = Array.from({length: 40}, (_, i) => ({ x: 500 + (i * 350), y: 180, w: 50, h: 50, active: true }));

document.getElementById('btn-start').onclick = () => {
    document.getElementById('start-screen').style.display = 'none';
    gameStarted = true; gameActive = true;
    failSound.play().then(() => { failSound.pause(); failSound.currentTime = 0; }).catch(() => {});
};

const keys = {};
window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

function drawPlayer() {
    ctx.save();
    ctx.translate(player.x + player.w / 2, player.y + player.h / 2);
    if (!player.facingRight) ctx.scale(-1, 1);
    ctx.fillStyle = "#ffdbac"; ctx.fillRect(-15, -30, 30, 25);
    ctx.fillStyle = "white"; ctx.fillRect(-10, -22, 8, 10); ctx.fillRect(2, -22, 8, 10);
    ctx.fillStyle = "black"; ctx.fillRect(-7, -19, 4, 5); ctx.fillRect(5, -19, 4, 5);
    ctx.fillStyle = "white"; ctx.fillRect(-16, -5, 32, 22);
    ctx.fillStyle = "#0055ff"; ctx.fillRect(-16, 17, 32, 13);
    ctx.fillStyle = "#ffdbac"; ctx.fillRect(-12, 30, 8, 5); ctx.fillRect(4, 30, 8, 5);
    ctx.restore();
}

function triggerQuiz() {
    gameActive = false;
    const currentQ = questionsDeck[0];

    document.getElementById('question-text').innerText = currentQ.q;
    const container = document.getElementById('options-container');
    container.innerHTML = '';

    let opts = [...currentQ.a]; shuffle(opts);

    opts.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn'; btn.innerText = opt;
        btn.onclick = () => {
            document.getElementById('quiz-overlay').style.display = 'none';
            if (opt === currentQ.correct) {
                coins += 10; streak++;
                if (streak === 10) { coins += 5; streak = 0; }
                document.getElementById('stats-coins').innerText = `Coins: ${coins}`;
                questionsDeck.shift();
                gameActive = (timer > 0);
            } else {
                streak = 0; isFalling = true; failSound.play();
                questionsDeck.push(questionsDeck.shift());
            }
        };
        container.appendChild(btn);
    });

    document.getElementById('quiz-overlay').style.display = 'flex';
}

function update() {
    if (!gameStarted) { requestAnimationFrame(update); return; }

    if (timer <= 0) {
        gameActive = false;
        document.getElementById('message').style.display = 'block';
        document.getElementById('message').innerText = "TIME UP!";
    }

    if (isFalling) {
        player.vy += gravity; player.y += player.vy;
        if (player.y > 500) {
            lives--; document.getElementById('stats-lives').innerText = `Lives: ${lives}`;
            if (lives <= 0) {
                gameActive = false;
                document.getElementById('message').style.display = 'block';
                document.getElementById('message').innerText = "GAME OVER";
            } else {
                player.x -= 300; player.y = 100; player.vy = 0; isFalling = false;
                if (timer > 0) gameActive = true;
            }
        }
    } else if (gameActive) {
        if (keys['ArrowRight']) { player.vx = player.speed; player.facingRight = true; }
        else if (keys['ArrowLeft']) { player.vx = -player.speed; player.facingRight = false; }
        else player.vx *= 0.8;

        if (keys['Space'] && player.grounded) { player.vy = player.jumpPower; player.grounded = false; }

        player.vy += gravity; player.x += player.vx; player.y += player.vy;

        if (player.y + player.h > 350) { player.y = 350 - player.h; player.vy = 0; player.grounded = true; }

        blocks.forEach((b) => {
            if (b.active && player.x < b.x + b.w && player.x + player.w > b.x && player.y < b.y + b.h && player.y + player.h > b.y) {
                if (player.vy < 0) {
                    b.active = false; player.vy = 2;
                    if (questionsDeck.length > 0) triggerQuiz();
                    else {
                        gameActive = false;
                        document.getElementById('message').style.display = 'block';
                        document.getElementById('message').innerText = "MASTERY!";
                    }
                }
            }
        });
    }

    ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height);
    let camX = -player.x + 150; if (camX > 0) camX = 0;
    ctx.translate(camX, 0);

    ctx.fillStyle = isFalling ? '#111' : '#333'; ctx.fillRect(-1000, 350, 20000, 50);

    blocks.forEach(b => {
        if (b.active) {
            ctx.fillStyle = '#ffd600'; ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.fillStyle = 'black'; ctx.font = 'bold 20px Arial'; ctx.fillText('?', b.x+15, b.y+33);
        }
    });

    drawPlayer();
    requestAnimationFrame(update);
}

setInterval(() => {
    if (gameActive && timer > 0) {
        timer--;
        document.getElementById('stats-timer').innerText = timer + "s";
    }
}, 1000);

update();
</script>
</body>
</html>
